#!perl

# intrastops.pl

use strict;
no strict 'subs';

require 'pubinflib.pl';

use constant ProgramTitle => "AC Transit Stop Signage Database";
use constant TAB => "\t";

my (%types , @refs, @keys, %stopdata, $stopdialog, $dataresult, $tpresult);

our ( %stops );

chdir get_directory() or die "Can't change to specified directory.\n";

my $stopsfile = ($ARGV[1] or "stops.txt");

@refs = readstops ($stopsfile);
@keys = @{shift @refs};
%stops = %{shift @refs};

init_vars();

#open OUT , ">signlist.html";
open OUT , ">w:/marcom/signlist.html" or die;

open FIELD, ">fieldwork.txt" or die;

select OUT;

print <<'EOF';
<html><head><title>Stop-specific signage</title>
<!-- don't edit this file, it's generated by a program -->
</head>
<body>

<h1>Stop-specific signage</h1>
<p>This is a list of signs in the district with site-specific 
schedule information. Write <a href="mailto:apriven@actransit.org">
Aaron Priven</a> for more information.</p>

<p>The list is sorted by project, then by city, then by the street names.</p>

EOF

# okay, so now @keys are all the valid fields, and @stops is the list of stops

%types = (CN => '6"x23" pole schedule' ,
          CW => '11"x23" pole schedule' ,
          R22 => '8"x22" pole schedule' ,
          L21 => 'Lamar bus shelter (22"x36" info case)' ,
          T24 => '24"x24" information tube' );

printheaders();

foreach (sort 
        {  
          $stops{$a}{"Project"} cmp $stops{$b}{"Project"} or 
          $stops{$a}{"City"} cmp $stops{$b}{"City"} or 
          $stops{$a}{"On"} cmp $stops{$b}{"On"} or 
          $stops{$a}{"At"} cmp $stops{$b}{"At"} or
          $stops{$a}{"StNum"} <=> $stops{$b}{"StNum"} or
          $stops{$a}{"Direction"} cmp $stops{$b}{"Direction"} or
          $stops{$a}{"StopID"} <=> $stops{$b}{"StopID"} 
        } 
      keys %stops) 
{

   next if $stops{$_}{"Inactive"};
 
   print "<tr><td>";

   my $desc = stopdescription ($_ , $stops {$_} , 1) ;
   $desc =~ s/\(\#.*?\)//;

   print join(   "</td><td>"  ,
          $stops{$_}{"StopID"} ,
#          $stops{$_}{"City"} ,
#          $stops{$_}{"Neighborhood"} ,
#          stopdescription ($_ , $stops {$_} , 1) ,
          $desc,
          ( $types{$stops{$_}{"SignType"}} or $stops{$_}{"SignType"} ) ,
          $stops{$_}{"PrintNotes"} ,
          $stops{$_}{"DatePrinted"} ,
          $stops{$_}{"Project"} );
          
   print "</td></tr>\n";


   print FIELD join( TAB ,
          $stops{$_}{"StopID"} ,
          $stops{$_}{"City"} ,
          $stops{$_}{"Neighborhood"} ,
          $desc,
          $stops{$_}{"NearFar"} ,
          ( $types{$stops{$_}{"SignType"}} or $stops{$_}{"SignType"} ) ,
          $stops{$_}{"PrintNotes"} ,
          $stops{$_}{"DatePrinted"} ,
          $stops{$_}{"Inactive"} ,
          $stops{$_}{"Project"} ) , "\n";

}

print "</table>\n";

print "<p>Last updated:" , scalar(localtime()) , "</p></body></html>";

######################
# END OF MAIN PROGRAM
######################

sub printheaders {

   print OUT "<table border=1>\n<tr><th>" , join ("</th><th>" , 
     "Stop ID" , 
# "City" , "Neighborhood" , 
        "Location" ,
       "Sign Type" , "Notes" , "Date Printed" , "Project" );
   print OUT "</th></tr>\n";


}
