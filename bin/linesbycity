#!/usr/bin/perl

use strict;

# initialization

use FindBin('$Bin'); 
   # so $Bin is the location of the very file we're in now

use lib $Bin; 
   # there are few enough files that it makes sense to keep
   # main program and library in the same directory

# libraries dependent on $Bin

use FPMerge qw(FPread FPread_simple);
use Skeddir;
use Byroutes 'byroutes';
use Myopts;

my %options;
Myopts::options (\%options, Skeddir::options(), 'quiet!');
# command line options in %options;

# $| = 1; # makes output "hot"

my $signup;
$signup = (Skeddir::change (\%options))[2];
# Takes the necessary options to change directories, plus 'quiet', and
# then changes directories to the "Skeds" base directory.

# open and load files

print STDERR "Using signup $signup\n\n" unless $options{quiet};

print STDERR <<"EOF" unless $options{quiet};
Now loading data...
EOF

# read in FileMaker Pro data into variables in package main

our (@stops, %stops);

FPread_simple ("Stops.csv" , \@stops , \%stops , 'stop_id_1');

print STDERR scalar(@stops) , " stops.\n";

# fields - stop_id_1,STOPROUTES,UNSHOWNROU,ERRSHOWNRO,POLENUM,SHELTR,TIMEPOINT,SignID,MyNeighborhood,MyPoleType,MyDescription,CityF,OnF,AtF,StNumF,CommentF,CornerF,SiteF,DirectionF,NotesForR_P

my %hash = ();

foreach my $stop (@stops) {

   my @routes = split(/\./ , $stop->{STOPROUTES});
   foreach (@routes) {

      next if /NULL/;
      my $city = $stop->{CityF};
      $city =~ s/^\s+//;
      $city =~ s/\s+$//;
      $hash{$city}{$_}++;
   }
}

foreach my $city (sort keys %hash) {

   print "$city: ";
   print join ( ", " , sort byroutes keys (%{$hash{$city}} ) );
   print "\n";

}
