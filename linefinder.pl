#!/Activeperl/bin/perl

use 5.010;
use strict;
use warnings;

# initialization

use FindBin('$Bin'); 
   # so $Bin is the location of the very file we're in now

use lib $Bin; 
   # there are few enough files that it makes sense to keep
   # main program and library in the same directory

# libraries dependent on $Bin

use Actium::Sorting (qw(sortbyline));
use Actium::Files::Merge::FPMerge qw(FPread FPread_simple);
use Linelist('linelist');

use Actium::Options (qw<option add_option init_options>);
#add_option ('spec' , 'description');
use Actium::Term (qw<printq sayq>);
use Actium::Signup;

init_options;

my $signupdir = Actium::Signup->new();
chdir $signupdir->path();
my $signup = $signupdir->signup;

my $current_version = '16';

use autodie;

open my $date , "<effectivedate.txt" ;

our $effdate = scalar <$date>;
close $date;

chomp $effdate;
$effdate =~ s/\r//g;

my (@lines, %lines);
FPread_simple ("Lines.csv" , \@lines, \%lines, 'Line');

my %desc_of;

my (%group);



for my $line (linelist()) {

   next if $line =~ /\ABS[DHN]\z/;

   $desc_of{$line} = $lines{$line}{Description};

   given ($line) {
      when (/^6\d\d/) {
         push @{$group{Supplementary}}, $line;
      }
      when (/^8\d\d/) {
         push @{$group{AllNighter}}, $line;
      }
      when (/^[A-Z]/) {
         push @{$group{Transbay}}, $line;
      }
      default {
         push @{$group{Local}}, $line;
      }

   }
}

open my $out , '>' , 'linefinder.htm';

print $out header($effdate);

say $out "\n<!--\n    Do not edit this file! It is automatically generated from a program.\n-->";

foreach (qw/Local Transbay Supplementary AllNighter/) {
    # heading 
    my $pub = $_;
    $pub = 'All Nighter' if /AllNighter/;
    $pub .= ' Lines';
    
    print $out qq{<table style="border-collapse: collapse;" border="1"><caption style="padding-top: 1.2em;"><strong><a name="$_">$pub</a></strong></caption>};

    print $out '<thead><tr><th style="background-color: silver;">Lines</th><th style="background-color: silver;">Description</th>';
    
    say $out '<th style="background-color: silver;">Links</th></thead>';   
    
    print $out '<tbody>';

    foreach my $line (sortbyline @{$group{$_}} ) {

       print $out qq{<tr><td style="text-align: center;">$line</td>};
       print $out qq{<td style="padding: 2pt;">$desc_of{$line}</td>};
       print $out '<td style="text-align: center;">';
       print $out qq{<a href="http://www.actransit.org/maps/maps_results.php?ms_view_type=2&maps_line=$line&version_id=$current_version&map_submit=Get+Map">Map</a>};
       print $out "<br>";
       print $out qq{<a href="http://www.actransit.org/maps/schedule_results.php?quick_line=$line&Go=Go">Schedule</a>};
       say $out '</td></tr>';

    }
    say $out '</tbody></table>';

}

print $out FOOTER();

close $out;

###########################################################################
# END OF MAIN PROGRAM
###########################################################################

sub FOOTER {

my $footer = <<'EOF';
  <p> <strong>Find <a href="http://www.actransit.org/maps/index.php">maps 
    &amp; schedules</a> for these lines.</strong> Or call 511 and say 
    &quot;AC Transit&quot; for trip-planning assistance.</p>
EOF

$footer =~ s/\n/ /g;
$footer =~ s/ +/ /g;

return $footer;

}

sub header {

   my $effdate = shift;

my $header = <<"EOF";
<p>Effective $effdate</p>

<h2>About Bus Line Numbers and Letters</h2>

<p>AC Transit's numbered lines serve the East Bay. </p>

<p>Lines 1–299 operate normal hours. Normal hours are, at a minimum,
the commute periods, 6 a.m. – 9 a.m. and 4 p.m. – 6 p.m., weekdays.
Almost all operate all day on weekdays and many operate weekday
evenings and weekends as well. Lines 200-299 serve the areas of
Fremont and Newark, while other lines serve other parts of the East
Bay from Richmond to Hayward.</p>

<p>Lines 300–399 do not operate during the commute period. They
operate at other times of the day: for example, mid-days only,
weekends only, or evenings only. Some lines operate only a few days
per week (for example, Tuesdays and Thursdays).</p>

<p>Lines 600–699 are timed to match the instruction hours of local
schools, and operate only when schools are in session. They may
have altered schedules when local schools have minimum day or
alternative schedules. These lines are open to all passengers at
regular fares.</p>

<p>Lines 800–899 are All Nighter lines, operating from 1 a.m. – 5
a.m. daily. Some may operate somewhat earlier or later (especially
on weekends).</p>

<p>Lettered lines (A-Z) are Transbay routes, connecting the East
Bay to San Francisco or the Peninsula.</p>

<hr/>

<p><strong>Go to the <a href="http://www.actransit.org/maps/index.php">Maps &amp; Schedules</a> page.
</strong></p>

  <p > 
  <a href="#Local">Local Lines</a><br>
  <a href="#Transbay">Transbay Lines</a><br>
  <a href="#AllNighter">All Nighter Lines</a> <br>
  <a href="#Supplementary">Supplementary Lines</a><br>
</p>

<hr>
EOF

$header =~ s/\n/ /g;
$header =~ s/ +/ /g;

return $header;

}
